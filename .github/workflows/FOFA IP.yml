name: FOFA IP + IPTV

on:
  schedule:
    - cron: "*/30 * * * *"  # æ¯ 15åˆ†é’Ÿ
  workflow_dispatch:        # æ”¯æŒæ‰‹åŠ¨è§¦å‘

jobs:
  fetch-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: 1. Checkout repository
        uses: actions/checkout@v4

      - name: 2. Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: 3. Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: 4. Install ffmpeg
        run: sudo apt-get update && sudo apt-get install -y ffmpeg

      - name: 5. è¿è¡Œ FOFA æŠ“å–ä¸æ£€æµ‹
        run: |
          python py/fofa/2026.py
          python py/fofa/Detection_ip.py

      - name: 6. ç”Ÿæˆ M3U ä¸ TXT åˆ—è¡¨ (æ ¸å¿ƒæ­¥éª¤)
        run: python py/fofa/fofa-m3u.py

      - name: 7. æäº¤å¹¶æ¨é€å˜æ›´
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          # å¼ºåˆ¶æ·»åŠ æ‰€æœ‰ç”Ÿæˆçš„æˆæœæ–‡ä»¶
          git add py/fofa/è®¡æ•°.txt || true
          git add py/fofa/ip/*.txt || true
          git add py/fofa/IPTV.txt || true
          git add py/fofa/IPTV.m3u || true
          git add py/fofa/m3u_groups/*.m3u || true

          # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶å˜åŠ¨
          if git diff --staged --quiet; then
            echo "âš ï¸ æ²¡æœ‰æ£€æµ‹åˆ°å†…å®¹æ›´æ–°ï¼Œè·³è¿‡æäº¤ã€‚"
          else
            echo "ğŸš€ å‘ç°æ›´æ–°ï¼Œæ­£åœ¨æ¨é€åˆ°ä»“åº“..."
            git commit -m "è‡ªåŠ¨æ›´æ–°ï¼šIP èµ„æºä¸ M3U åˆ—è¡¨ ($(date +'%Y-%m-%d %H:%M'))"
            git pull --rebase origin main
            git push origin main
          fi
